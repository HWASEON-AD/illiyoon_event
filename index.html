<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>일리윤 오프라인 이벤트</title>

<style>
:root{
  --bg-w:1366; --bg-h:1024;

  /* ✅ 슬롯 위치/크기 (여기 숫자만 만지면 “딱 맞게” 조절됨) */
  --slot-left:531;
  --slot-top:435;     /* 기존 415 → 435 (필요하면 432~445 사이로 미세조정) */
  --slot-w:302;
  --slot-h:310;

  --radius:20px;
  --shadow:0 12px 30px rgba(0,0,0,.18);
  --win-blue:#1d4ed8;
  --win-neon:#38bdf8;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{
  margin:0;background:#0b1220;
  display:flex;align-items:center;justify-content:center;
  min-height:100svh;padding:12px;
  font-family:-apple-system,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
}

.stage{
  position:relative;
  width:min(100vw - 24px,1100px);
  aspect-ratio:calc(var(--bg-w)/var(--bg-h));
  overflow:hidden;border-radius:18px;
  box-shadow:0 22px 60px rgba(0,0,0,.35);
}
.bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}

/* 슬롯 */
.slot{
  position:absolute;
  left:calc(100%*(var(--slot-left)/var(--bg-w)));
  top: calc(100%*(var(--slot-top)/var(--bg-h)));
  width:calc(100%*(var(--slot-w)/var(--bg-w)));
  height:calc(100%*(var(--slot-h)/var(--bg-h)));
  background:rgba(255,255,255,.45);
  backdrop-filter:blur(2px);
  border-radius:var(--radius);
  overflow:hidden;
  box-shadow:var(--shadow);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* 마스크 */
.slot::before,
.slot::after{
  content:"";
  position:absolute;left:0;right:0;height:26%;
  pointer-events:none;z-index:2;
}
.slot::before{
  top:0;
  background:linear-gradient(to bottom,rgba(255,255,255,.9),rgba(255,255,255,0));
}
.slot::after{
  bottom:0;
  background:linear-gradient(to top,rgba(255,255,255,.9),rgba(255,255,255,0));
}

/* 이미지 */
.slot img{
  width:100%;height:100%;
  object-fit:contain;
  display:block;pointer-events:none;z-index:1;
}

/* 회전 중 */
.slot.spinning img{ filter: blur(1.6px); }

/* 당첨 */
.slot.winner{
  border:2px solid var(--win-blue);
  box-shadow:
    0 0 0 6px rgba(29,78,216,.2),
    0 0 18px var(--win-neon),
    0 0 40px rgba(56,189,248,.35),
    var(--shadow);
}

/* 덜컹 */
@keyframes snap{
  0%{transform:translateY(6px)}
  70%{transform:translateY(-3px)}
  100%{transform:translateY(0)}
}
.slot.snap img{ animation:snap .2s ease-out }

/* 관리자 */
.adminBtn{
  position:absolute;right:12px;bottom:12px;
  width:44px;height:44px;border-radius:14px;
  background:rgba(0,0,0,.35);color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-size:18px;cursor:pointer;z-index:10;
}

.panel{
  position:absolute;inset:0;
  background:rgba(0,0,0,.45);
  display:none;z-index:20;
}
.panel.on{display:block}

.card{
  max-width:720px;margin:40px auto;
  background:#fff;border-radius:18px;
  overflow:hidden;
}
.cardHd{
  padding:14px;
  display:flex;justify-content:space-between;align-items:center;
  border-bottom:1px solid #ddd;
}
.cardHd b{font-size:16px}
.cardBd{padding:14px}

table{width:100%;border-collapse:collapse;}
th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px;}
th{text-align:left;background:#f6f6f6}

input[type="text"], input[type="number"]{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
}
.closeBtn{
  border:none;background:none;
  font-size:20px;cursor:pointer;
}
.hint{
  font-size:12px;color:#666;margin:10px 0 0;
  line-height:1.35;
}
</style>
</head>

<body>
<div class="stage">
  <img class="bg" src="index_bg.png" alt="bg">

  <div class="slot" id="slot">
    <img id="slotImg" alt="slot">
  </div>

  <div class="adminBtn" id="adminBtn">⚙️</div>

  <div class="panel" id="panel">
    <div class="card">
      <div class="cardHd">
        <b>재고/확률 관리</b>
        <button class="closeBtn" id="closeBtn">✕</button>
      </div>
      <div class="cardBd">
        <table>
          <thead>
            <tr>
              <th style="width:45%">제품명</th>
              <th style="width:20%">재고</th>
              <th style="width:25%">확률(%)</th>
              <th style="width:10%">미리</th>
            </tr>
          </thead>
          <tbody id="stockBody"></tbody>
        </table>
        <div class="hint">
          * 확률은 %로 입력. 합은 항상 100%로 자동 보정됨<br>
          * 재고가 0인 항목은 뽑기에서 자동 제외(남은 것끼리 재정규화)
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const KEY="pachinko_FINAL_ADMIN";

const defaultItems=[
 {id:1,name:"1",src:"1image.png"},
 {id:2,name:"2",src:"2image.png"},
 {id:3,name:"3",src:"3image.png"},
 {id:4,name:"4",src:"4image.png"},
];

let state=JSON.parse(localStorage.getItem(KEY))||{
 items:defaultItems,
 stocks:{1:1000,2:1000,3:1000,4:1000},
 last:1,
 probs:{1:25,2:25,3:25,4:25} // % 확률
};

/* 구버전 호환 */
if(!state.items || !state.items.length) state.items = defaultItems;
if(!state.stocks) state.stocks = {1:1000,2:1000,3:1000,4:1000};
if(!state.probs){
  state.probs = {};
  state.items.forEach(it=>state.probs[it.id]=25);
}
function save(){ localStorage.setItem(KEY,JSON.stringify(state)); }

const slot=document.getElementById("slot");
const slotImg=document.getElementById("slotImg");
const panel=document.getElementById("panel");
const stockBody=document.getElementById("stockBody");

function setSlotById(id){
  const it = state.items.find(x=>Number(x.id)===Number(id)) || state.items[0];
  if(!it) return;
  slotImg.src = "./" + it.src;
}
slotImg.onerror = ()=>console.log("슬롯 이미지 로드 실패:", slotImg.src);

setSlotById(state.last);

/* 합 100 유지: 바꾼 항목은 고정, 나머지 자동 조정(기존 비율 유지) */
function normalizeTo100(changedId){
  const ids = state.items.map(x=>x.id);

  // 정리
  ids.forEach(id=>{
    const v = Number(state.probs[id]);
    state.probs[id] = isFinite(v) ? Math.max(0, v) : 0;
  });

  const fixed = Number(state.probs[changedId]) || 0;
  const others = ids.filter(id=>id!==changedId);
  const sumOthers = others.reduce((a,id)=>a+(Number(state.probs[id])||0),0);

  let remain = 100 - fixed;

  if(remain < 0){
    state.probs[changedId] = 100;
    others.forEach(id=>state.probs[id]=0);
    return;
  }

  if(!others.length) return;

  if(sumOthers <= 0){
    const each = remain / others.length;
    others.forEach(id=>state.probs[id]=each);
  }else{
    others.forEach(id=>{
      state.probs[id] = (Number(state.probs[id])||0) * (remain / sumOthers);
    });
  }

  // 0.1 단위 반올림 + 합 100 보정
  ids.forEach(id=> state.probs[id] = Math.round(state.probs[id]*10)/10);
  const sum = ids.reduce((a,id)=>a+state.probs[id],0);
  const diff = Math.round((100 - sum)*10)/10;
  const lastId = ids[ids.length-1];
  state.probs[lastId] = Math.round((state.probs[lastId] + diff)*10)/10;
}

/* 관리자 렌더 */
function renderStock(){
  stockBody.innerHTML="";

  state.items.forEach(it=>{
    const tr=document.createElement("tr");

    // 제품명
    const tdName=document.createElement("td");
    const nameInput=document.createElement("input");
    nameInput.type="text";
    nameInput.value=it.name ?? "";
    nameInput.oninput=()=>{
      it.name=nameInput.value;
      save();
    };
    tdName.appendChild(nameInput);

    // 재고
    const tdStock=document.createElement("td");
    const stockInput=document.createElement("input");
    stockInput.type="number";
    stockInput.min="0";
    stockInput.step="1";
    stockInput.value=state.stocks[it.id] ?? 0;
    stockInput.oninput=()=>{
      state.stocks[it.id]=Math.max(0, Math.floor(+stockInput.value||0));
      save();
    };
    tdStock.appendChild(stockInput);

    // 확률 %
    const tdProb=document.createElement("td");
    const probInput=document.createElement("input");
    probInput.type="number";
    probInput.min="0";
    probInput.max="100";
    probInput.step="0.1";
    probInput.value=state.probs[it.id] ?? 0;

    probInput.oninput=()=>{
      state.probs[it.id]=Math.max(0, +probInput.value||0);
      normalizeTo100(it.id);
      save();
      renderStock(); // 자동 보정값 반영
    };
    tdProb.appendChild(probInput);

    // 미리보기
    const tdPrev=document.createElement("td");
    const img=document.createElement("img");
    img.src="./"+it.src;
    img.style.width="36px";
    img.style.height="36px";
    img.style.objectFit="contain";
    img.onerror=()=>{ img.style.display="none"; };
    tdPrev.appendChild(img);

    tr.appendChild(tdName);
    tr.appendChild(tdStock);
    tr.appendChild(tdProb);
    tr.appendChild(tdPrev);
    stockBody.appendChild(tr);
  });
}

/* 뽑기: 재고>0 & 확률>0인 것만으로 확률 재정규화 */
function pick(){
  const pool = state.items
    .map(it=>{
      const stock = +state.stocks[it.id] || 0;
      const p = +state.probs[it.id] || 0;
      return {id:it.id, stock, p};
    })
    .filter(x=>x.stock>0 && x.p>0);

  if(!pool.length) return null;

  const sumP = pool.reduce((a,b)=>a+b.p,0);
  let r = Math.random()*sumP;

  for(const x of pool){
    r -= x.p;
    if(r<=0) return x.id;
  }
  return pool[pool.length-1].id;
}

let spinning=false;
slot.onclick=()=>{
  if(spinning) return;

  const final=pick();
  if(!final) return;

  spinning=true;
  slot.classList.remove("winner","snap");
  slot.classList.add("spinning");

  let idx=0;
  const timer=setInterval(()=>{
    const it = state.items[idx % state.items.length];
    slotImg.src = "./" + it.src;
    idx++;
  },70);

  setTimeout(()=>{
    clearInterval(timer);

    state.stocks[final] = Math.max(0, (+state.stocks[final]||0)-1);
    state.last=final;
    save();

    setSlotById(final);

    slot.classList.remove("spinning");
    slot.classList.add("winner","snap");

    setTimeout(()=>slot.classList.remove("snap"),220);
    spinning=false;
  },1000);
};

/* 관리자 */
document.getElementById("adminBtn").onclick=()=>{
  renderStock();
  panel.classList.add("on");
};
document.getElementById("closeBtn").onclick=()=>panel.classList.remove("on");
</script>
</body>
</html>
